<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Splash</title>

<style>
:root{
  --bg:#0b1220;
  --table1:#12204a;
  --table2:#0c1430;
  --accent:#63b3ed;
  --danger:#ff7b72;
  --ok:#7ee787;
  --muted:rgba(230,237,247,.7);
  --card-w: clamp(48px, 9vw, 76px);
  --card-h: calc(var(--card-w) * 1.45);
}

*{ box-sizing:border-box; }

body{
  margin:0;
  font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:#e6edf7;
  background: radial-gradient(circle at top, #142046, var(--bg) 65%);
  overflow-x:hidden;
}

header{
  padding:10px 12px;
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:center;
  border-bottom:1px solid rgba(255,255,255,.08);
}

h1{ margin:0; font-size:16px; font-weight:800; }

input,button{
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.18);
  color:#e6edf7;
  padding:8px 10px;
  border-radius:12px;
  font-size:13px;
}

button.primary{ background:rgba(99,179,237,.25); border-color:rgba(99,179,237,.5); }
button.danger{ background:rgba(255,123,114,.2); border-color:rgba(255,123,114,.5); }

main{ padding:12px 12px 140px; }

.playersRow{
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(140px,1fr));
  gap:8px;
  margin-bottom:10px;
}

.playerChip{
  display:flex;
  gap:8px;
  align-items:center;
  padding:6px 8px;
  border-radius:14px;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.12);
}

.playerChip.active{
  outline:2px solid var(--accent);
}

.avatar{
  width:36px;height:36px;
  border-radius:50%;
  background:#fff;
  color:#000;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  font-weight:900;
}

.table{
  background: linear-gradient(180deg,var(--table1),var(--table2));
  border-radius:20px;
  padding:12px;
}

.pileWrap{
  margin:12px 0;
  height:140px;
  border-radius:16px;
  border:2px dashed rgba(255,255,255,.25);
  display:flex;
  align-items:center;
  justify-content:center;
  transition:.15s ease;
}

.pileWrap.drag-over{
  border-color:var(--accent);
  background:rgba(99,179,237,.15);
}

.handGrid{
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(var(--card-w),1fr));
  gap:8px;
  justify-items:center;
}

.c{
  width:var(--card-w);
  height:var(--card-h);
  border-radius:12px;
  background:#fff;
  color:#111;
  position:relative;
  box-shadow:0 6px 16px rgba(0,0,0,.45);
  touch-action:none;
}

.c.illegal{ opacity:.4; }

.corner{
  position:absolute;
  font-weight:800;
  font-size:12px;
}
.corner.top{ top:6px; left:6px; }
.corner.bottom{ bottom:6px; right:6px; transform:rotate(180deg); }

.pip{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:26px;
}

.panel{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  padding:10px;
  background:rgba(15,20,40,.96);
  border-top:1px solid rgba(255,255,255,.12);
  display:flex;
  gap:10px;
}

@media(min-width:900px){
  main{ padding-bottom:16px; }
  .panel{ position:static; background:none; border:none; }
}

@media(max-width:900px){
  #playBtn{ display:none; }
}
</style>
</head>

<body>

<header>
  <h1>üÉè Splash</h1>
  <input id="mpName" placeholder="Name">
  <input id="mpRoom" placeholder="ROOM">
  <button id="hostBtn" class="primary">Host</button>
  <button id="joinBtn" class="primary">Join</button>
</header>

<main>
  <div class="playersRow" id="playersRow"></div>

  <section class="table">
    <div class="pileWrap" id="pileWrap">DROP HERE</div>

    <h3>Your Hand</h3>
    <div id="yourHand" class="handGrid"></div>
  </section>
</main>

<div class="panel">
  <button id="pickupBtn" class="danger">Pick Up Pile</button>
  <button id="playBtn" class="primary">Play Selected</button>
</div>

<script>
const WS_BASE = "wss://splash-multiplayer.azimaymen.workers.dev";
const clientId = crypto.randomUUID();
let ws, room, mySeat = null, dragged = null;

const state = {
  players: [],
  pile: [],
  currentPlayer: 0
};

const el = id => document.getElementById(id);

function connect(roomCode, isHost){
  room = roomCode;
  ws = new WebSocket(`${WS_BASE}?room=${room}`);
  ws.onopen = () => ws.send(JSON.stringify({
    type:"join",
    id:clientId,
    name:el("mpName").value
  }));

  ws.onmessage = e => {
    const msg = JSON.parse(e.data);
    if(msg.type==="players"){
      state.players = msg.players;
      mySeat = msg.players.find(p=>p.id===clientId)?.seat ?? null;
      renderPlayers();
    }
    if(msg.type==="state"){
      Object.assign(state, msg.payload.state);
      renderHand();
    }
  };
}

el("hostBtn").onclick = () => {
  const code = Math.random().toString(36).slice(2,6).toUpperCase();
  el("mpRoom").value = code;
  connect(code,true);
};

el("joinBtn").onclick = () => {
  connect(el("mpRoom").value,false);
};

function renderPlayers(){
  el("playersRow").innerHTML="";
  state.players.forEach((p,i)=>{
    const d=document.createElement("div");
    d.className="playerChip"+(i===state.currentPlayer?" active":"");
    d.innerHTML=`<div class="avatar">${p.name[0]}</div><div>${p.name}</div>`;
    el("playersRow").appendChild(d);
  });
}

function renderHand(){
  const h=el("yourHand");
  h.innerHTML="";
  if(mySeat===null) return;
  const me=state.players[mySeat];
  if(!me?.hand) return;

  me.hand.forEach(card=>{
    const d=document.createElement("div");
    d.className="c";
    d.innerHTML=`<div class="corner top">${card.rank}</div>
                 <div class="pip">${card.suit}</div>
                 <div class="corner bottom">${card.rank}</div>`;

    d.onpointerdown = e=>{
      if(state.currentPlayer!==mySeat) return;
      dragged=card.id;
      d.setPointerCapture(e.pointerId);
    };

    d.onpointermove = e=>{
      if(!dragged) return;
      const pile=el("pileWrap").getBoundingClientRect();
      const over =
        e.clientX>pile.left && e.clientX<pile.right &&
        e.clientY>pile.top && e.clientY<pile.bottom;
      el("pileWrap").classList.toggle("drag-over",over);
    };

    d.onpointerup = ()=>{
      el("pileWrap").classList.remove("drag-over");
      if(dragged){
        ws.send(JSON.stringify({
          type:"action",
          action:{ type:"UPDATE", state }
        }));
      }
      dragged=null;
    };

    h.appendChild(d);
  });
}
</script>

</body>
</html>
